<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Firestore Live Games Viewer</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
    <!-- Luxon for date/time handling -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.x/build/global/luxon.min.js"></script>
    <style>
        body {
            background-color: #111;
            color: #e0e0e0;
            font-family: sans-serif;
            padding: 2rem;
        }
        .league-section {
            margin-bottom: 3rem;
        }
        .league-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #555;
            padding-bottom: 0.3rem;
            /* Ensure league title aligns with the table content */
            padding-left: 10px; /* Match the padding of the first column */
        }
        .game-table {
            width: 100%;
            border-collapse: collapse;
        }
        .game-table td {
            padding: 4px 10px; /* Default cell padding */
            vertical-align: top;
        }
        /* --- NEW/MODIFIED CSS FOR COLUMN WIDTHS AND ALIGNMENT --- */
        .game-table td:nth-child(1) { /* First column (time/status) */
            width: 90px; /* Fixed width for time/status column */
            min-width: 90px; /* Ensure it doesn't shrink */
            text-align: left; /* Align time/status to the left */
        }
        .team-cell { /* Second column (team name) */
            white-space: nowrap;
            text-align: left; /* Ensure team name is left-aligned */
            /* Remove explicit padding-left here, let td:nth-child(1) handle overall table padding */
        }
        .game-table td:nth-child(3) { /* Third column (score) */
            width: 40px; /* Fixed width for score */
            min-width: 40px;
            text-align: right; /* Align score to the right */
        }
        .game-table td:nth-child(4) { /* Fourth column (empty spacer) */
            width: 10px; /* Small fixed width for separation */
            min-width: 10px;
        }
        /* --- END NEW/MODIFIED CSS --- */

        .game-row {
            border-bottom: 1px solid #333;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Live & Upcoming Games</h1>
    <div id="games"></div>
    <div id="error" class="error"></div>

    <script>
        // Function to map original league names from Firestore to desired display names
        function getLeagueDisplayName(originalLeagueName) {
            const exactLeagueMaps = {
                "USA: WNBA": "WNBA",
                "USA: MLB": "MLB",
                "EUROPE: UEFA CHAMPIONS LEAGUE": "UEFA Champions League",
                "EUROPE: UEFA WOMEN'S CHAMPIONS LEAGUE": "UEFA Women's Champions League",
                "USA: NBA": "NBA",
                "USA: NHL": "NHL",
                "USA: NFL": "NFL",
                "USA: NCAAB": "NCAAB",
                "USA: NCAAF": "NCAAF",
                "ENGLAND: PREMIER LEAGUE": "Premier League",
                "GERMANY: BUNDESLIGA": "Bundesliga",
                "SPAIN: LALIGA": "LaLiga",
                "ITALY: SERIE A": "Serie A",
                "FRANCE: LIGUE 1": "Ligue 1",
                "USA: MLS": "MLS"
                // Add all your specific league mappings here.
            };

            if (exactLeagueMaps.hasOwnProperty(originalLeagueName)) {
                return exactLeagueMaps[originalLeagueName];
            }
            return originalLeagueName;
        }

        // Function to map original team names to desired display names (mascot names)
        function getTeamDisplayName(originalTeamName) {
            let processedTeamName = originalTeamName;
            if (processedTeamName.endsWith(" W")) {
                processedTeamName = processedTeamName.slice(0, -2);
            }

            const exactTeamMaps = {
                // MLB Teams
                "Arizona Diamondbacks": "Diamondbacks", "Atlanta Braves": "Braves", "Baltimore Orioles": "Orioles",
                "Boston Red Sox": "Red Sox", "Chicago Cubs": "Cubs", "Chicago White Sox": "White Sox",
                "Cincinnati Reds": "Reds", "Cleveland Guardians": "Guardians", "Colorado Rockies": "Rockies",
                "Detroit Tigers": "Tigers", "Houston Astros": "Astros", "Kansas City Royals": "Royals",
                "Los Angeles Angels": "Angels", "Los Angeles Dodgers": "Dodgers", "Miami Marlins": "Marlins",
                "Milwaukee Brewers": "Brewers", "Minnesota Twins": "Twins", "New York Mets": "Mets",
                "New York Yankees": "Yankees", "Athletics": "Athletics", "Philadelphia Phillies": "Phillies",
                "Pittsburgh Pirates": "Pirates", "San Diego Padres": "Padres", "San Francisco Giants": "Giants",
                "Seattle Mariners": "Mariners", "St. Louis Cardinals": "Cardinals", "Tampa Bay Rays": "Rays",
                "Texas Rangers": "Rangers", "Toronto Blue Jays": "Blue Jays", "Washington Nationals": "Nationals",

                // WNBA Teams
                "Atlanta Dream": "Dream", "Chicago Sky": "Sky", "Connecticut Sun": "Sun",
                "Dallas Wings": "Wings", "Indiana Fever": "Fever", "Las Vegas Aces": "Aces",
                "Los Angeles Sparks": "Sparks", "Minnesota Lynx": "Lynx", "New York Liberty": "Liberty",
                "Phoenix Mercury": "Mercury", "Seattle Storm": "Storm", "Washington Mystics": "Mystics",
                "Golden State Valkyries": "Valkyries"
                // Add all your specific team mappings here.
            };

            if (exactTeamMaps.hasOwnProperty(processedTeamName)) {
                return exactTeamMaps[processedTeamName];
            }
            return processedTeamName;
        }


        // Firebase Configuration (YOUR PROJECT SPECIFIC CONFIG)
        const firebaseConfig = {
            apiKey: "AIzaSyD3bw8d4q2oO2qpbgGiUG6Qnlf4aABK3Bc",
            authDomain: "flashlive-daily-scraper.firebaseapp.com",
            projectId: "flashlive-daily-scraper",
            storageBucket: "flashlive-daily-scraper.appspot.com",
            messagingSenderId: "124291936014",
            appId: "1:124291936014:web:acadcaa791d6046849315f",
            measurementId: "G-R146KS92QJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const collectionRef = db.collection("artifacts/flashlive-daily-scraper/public/data/sportsGames");

        /**
         * Sets up a real-time listener for games from Firestore, filters by today's Eastern Time date,
         * groups them by mapped league name, and updates the display on the page automatically.
         */
        async function setupRealtimeGameListener() {
            const container = document.getElementById("games");
            const errorDiv = document.getElementById("error");
            errorDiv.textContent = ""; // Clear previous errors

            try {
                const { DateTime } = luxon;
                const nowInEastern = DateTime.now().setZone('America/New_York');
                const todayStr = nowInEastern.toISODate();
                console.log(`[Frontend] Setting up listener for todayStr in Eastern Time: ${todayStr}`);

                // Create the query
                const gamesQuery = collectionRef
                    .where('gameDate', '==', todayStr)
                    .orderBy("Start Time");

                // Set up the real-time listener using onSnapshot
                gamesQuery.onSnapshot(snapshot => {
                    // Clear the container before re-rendering all games
                    container.innerHTML = "";

                    if (snapshot.empty) {
                        container.innerHTML = `<p>No games found for today (${todayStr}) in Firestore collection.</p>`;
                        return;
                    }

                    const leagueGroups = {};

                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const leagueDisplayName = getLeagueDisplayName(data.League) || "Other";
                        if (!leagueGroups[leagueDisplayName]) {
                            leagueGroups[leagueDisplayName] = [];
                        }
                        leagueGroups[leagueDisplayName].push(data);
                    });

                    for (const [leagueName, games] of Object.entries(leagueGroups)) {
                        const leagueSection = document.createElement("div");
                        leagueSection.className = "league-section";

                        const title = document.createElement("div");
                        title.className = "league-title";
                        title.textContent = leagueName;
                        leagueSection.appendChild(title);

                        const table = document.createElement("table");
                        table.className = "game-table";

                        let lastDisplayedTimeLabel = null;

                        games.forEach(data => {
                            const home = getTeamDisplayName(data["Home Team"]) || "";
                            const away = getTeamDisplayName(data["Away Team"]) || "";
                            const homeScore = data["Home Score"];
                            const awayScore = data["Away Score"];
                            const matchStatus = (data["Match Status"] || "").toUpperCase();
                            const inningStatus = (data["Status"] || "").toUpperCase();
                            const rawStart = data["Start Time"];

                            const isLive = matchStatus === "LIVE" || inningStatus.includes("INNING");
                            const isFinal = matchStatus === "FINISHED";

                            let currentTimeLabel = "";

                            if (isLive) {
                                currentTimeLabel = inningStatus || matchStatus;
                            } else if (isFinal) {
                                currentTimeLabel = "F";
                            } else if (rawStart) {
                                let gameDateFromFirestore;
                                if (typeof rawStart?.toDate === "function") {
                                    gameDateFromFirestore = rawStart.toDate();
                                } else if (typeof rawStart === "number") {
                                    gameDateFromFirestore = new Date(rawStart * 1000);
                                } else {
                                    gameDateFromFirestore = new Date(rawStart);
                                }

                                const startTimeLuxon = DateTime.fromJSDate(gameDateFromFirestore).setZone(DateTime.local().zoneName);
                                currentTimeLabel = startTimeLuxon.toFormat('h:mm a');
                            } else {
                                currentTimeLabel = "TBD";
                            }

                            let displayTimeLabel = currentTimeLabel;
                            if (currentTimeLabel === lastDisplayedTimeLabel) {
                                displayTimeLabel = "";
                            } else {
                                lastDisplayedTimeLabel = currentTimeLabel;
                            }

                            const row1 = document.createElement("tr");
                            row1.className = "game-row";
                            row1.innerHTML = `
                                <td>${displayTimeLabel}</td>
                                <td class="team-cell">${away}</td>
                                <td>${typeof awayScore !== "undefined" ? awayScore : ""}</td>
                                <td></td>
                            `;

                            const row2 = document.createElement("tr");
                            row2.className = "game-row";
                            row2.innerHTML = `
                                <td></td>
                                <td class="team-cell">${home}</td>
                                <td>${typeof homeScore !== "undefined" ? homeScore : ""}</td>
                                <td></td>
                            `;

                            table.appendChild(row1);
                            table.appendChild(row2);
                        });

                        leagueSection.appendChild(table);
                        container.appendChild(leagueSection);
                    }
                }, err => {
                    // Error handling for the snapshot listener
                    console.error("Error listening to Firestore updates:", err);
                    errorDiv.textContent = "Failed to load real-time data: " + err.message;
                });

            } catch (err) {
                // Error handling for initial setup of the listener
                console.error("Error setting up game listener:", err);
                errorDiv.textContent = "Failed to initialize real-time data: " + err.message;
            }
        }

        // Initial setup of the real-time listener when the page loads
        setupRealtimeGameListener();
    </script>
</body>
</html>
