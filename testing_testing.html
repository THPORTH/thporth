<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Firestore Live Games Viewer</title>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.x/build/global/luxon.min.js"></script>
    <style>
        body {
            background-color: #111;
            color: #e0e0e0;
            font-family: sans-serif;
            padding: 2rem;
        }
        .league-section {
            margin-bottom: 3rem;
        }
        .league-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #555;
            padding-bottom: 0.3rem;
        }
        .game-table {
            width: 100%;
            border-collapse: collapse;
        }
        .game-table td {
            padding: 4px 10px;
            vertical-align: top;
        }
        .game-row {
            border-bottom: 1px solid #333;
        }
        .team-cell {
            white-space: nowrap;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Live & Upcoming Games</h1>
    <div id="games"></div>
    <div id="error" class="error"></div>

    <script>
        <script>
        function getLeagueDisplayName(originalLeagueName) {
            const nameToSearch = (originalLeagueName || ""); // Keep original casing initially for specific checks
            const nameToSearchLower = nameToSearch.toLowerCase(); // Lowercase for general includes checks

            // Define your mapping rules. Order matters for prioritization!
            // Put more specific or unique keywords higher in the list.
            const leagueMaps = [
                // === Specific, complex keyword matches (e.g., exact phrase, but not part of another specific phrase) ===
                {
                    keyword: "UEFA Champions League", // Use the exact case/phrase you're looking for
                    displayName: "UEFA Champions League",
                    matchLogic: (name) => {
                        // This regex looks for "UEFA Champions League" as a contiguous phrase,
                        // not directly preceded by "Women's " (case-insensitive).
                        // It uses a negative lookbehind `(?<!women's\s)` (if browser supports it well)
                        // OR a simpler check for substring existence and then exclusion.
                        // For broader browser compatibility, a two-step check is safer.
                        const keywordLower = "uefa champions league";
                        const womenKeywordLower = "women's";

                        // First, check if the desired keyword is present contiguously
                        if (name.toLowerCase().includes(keywordLower)) {
                            // Then, check if the "women's" interruptor is also present right before it,
                            // or generally within the name.
                            if (name.toLowerCase().includes(`${womenKeywordLower} ${keywordLower}`)) {
                                return false; // Contains "women's UEFA Champions League", so this rule doesn't apply
                            }
                            return true; // Contains "UEFA Champions League" and not the women's version
                        }
                        return false; // Does not contain "UEFA Champions League"
                    }
                },

                // === General keyword matches (simple contiguous substring check) ===
                // Keywords here should be defined consistently (e.g., lowercase for includes, or match expected case).
                // If your Firestore is "USA: WNBA", use "WNBA" as keyword if you want to be case sensitive in map,
                // or 'wnba' and use lowercased check. Sticking with lowercase keywords for `includes` is common practice.
                { keyword: "wnba", displayName: "WNBA" },
                { keyword: "mlb", displayName: "MLB" },
                { keyword: "nba", displayName: "NBA" },
                { keyword: "nhl", displayName: "NHL" },
                { keyword: "nfl", displayName: "NFL" },
                { keyword: "ncaab", displayName: "NCAAB" }, // College Basketball
                { keyword: "ncaaf", displayName: "NCAAF" }, // College Football
                { keyword: "premier league", displayName: "Premier League" },
                { keyword: "bundesliga", displayName: "Bundesliga" },
                { keyword: "laliga", displayName: "LaLiga" },
                { keyword: "serie a", displayName: "Serie A" },
                { keyword: "ligue 1", displayName: "Ligue 1" },
                { keyword: "mls", displayName: "MLS" }
                // Add more keyword mappings here based on your Google Sheet data
            ];

            for (const map of leagueMaps) {
                if (map.matchLogic) {
                    // Use custom match logic for specific cases (like UEFA Champions League)
                    if (map.matchLogic(nameToSearch)) {
                        return map.displayName;
                    }
                } else {
                    // Default for most cases: simple substring inclusion (case-insensitive via lowercasing)
                    if (nameToSearchLower.includes(map.keyword.toLowerCase())) {
                        return map.displayName;
                    }
                }
            }

            // Fallback: If no match found, return the original name
            return originalLeagueName;
        }

        const firebaseConfig = {
            // ... your existing firebaseConfig ...
        };
        
        const firebaseConfig = {
            apiKey: "AIzaSyD3bw8d4q2oO2qpbgGiUG6Qnlf4aABK3Bc",
            authDomain: "flashlive-daily-scraper.firebaseapp.com",
            projectId: "flashlive-daily-scraper",
            storageBucket: "flashlive-daily-scraper.appspot.com",
            messagingSenderId: "124291936014",
            appId: "1:124291936014:web:acadcaa791d6046849315f",
            measurementId: "G-R146KS92QJ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const collectionRef = db.collection("artifacts/flashlive-daily-scraper/public/data/sportsGames");

        async function fetchGames() { // Renamed from fetchGamesNoFilter for clarity
            const container = document.getElementById("games");
            const errorDiv = document.getElementById("error");
            container.innerHTML = "";
            errorDiv.textContent = "";

            try {
                // Get today's date in Eastern Time, consistent with your backend
                const { DateTime } = luxon; // Access Luxon from the global object
                const nowInEastern = DateTime.now().setZone('America/New_York');
                const todayStr = nowInEastern.toISODate(); // 'YYYY-MM-DD'

                const snapshot = await collectionRef
                    .where('gameDate', '==', todayStr) // <--- ADD THIS FILTER!
                    .orderBy("Start Time")
                    .get(); // Removed limit, as we only want today's games

                if (snapshot.empty) {
                    container.innerHTML = `<p>No games found for today (${todayStr}) in Firestore collection.</p>`;
                    return;
                }

                const leagueGroups = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const league = data.League || "Other";
                    if (!leagueGroups[league]) {
                        leagueGroups[league] = [];
                    }
                    leagueGroups[league].push(data);
                });

                for (const [leagueName, games] of Object.entries(leagueGroups)) {
                    const leagueSection = document.createElement("div");
                    leagueSection.className = "league-section";

                    const title = document.createElement("div");
                    title.className = "league-title";
                    title.textContent = leagueName;
                    leagueSection.appendChild(title);

                    const table = document.createElement("table");
                    table.className = "game-table";

                    games.forEach(data => {
                        const home = data["Home Team"] || "";
                        const away = data["Away Team"] || "";
                        const homeScore = data["Home Score"];
                        const awayScore = data["Away Score"];
                        const matchStatus = (data["Match Status"] || "").toUpperCase();
                        const inningStatus = (data["Status"] || "").toUpperCase();
                        const rawStart = data["Start Time"];

                        const isLive = matchStatus === "LIVE" || inningStatus.includes("INNING");
                        const isFinal = matchStatus === "FINISHED";

                        let timeLabel = "";

                        if (isLive) {
                            timeLabel = inningStatus || matchStatus;
                        } else if (isFinal) {
                            timeLabel = "F";
                        } else if (rawStart) {
                            let gameDateFromFirestore;
                            if (typeof rawStart?.toDate === "function") {
                                gameDateFromFirestore = rawStart.toDate();
                            } else if (typeof rawStart === "number") {
                                gameDateFromFirestore = new Date(rawStart * 1000); // convert UNIX sec to ms
                            } else {
                                gameDateFromFirestore = new Date(rawStart);
                            }

                            // Format the time using Luxon for consistency
                            const startTimeLuxon = DateTime.fromJSDate(gameDateFromFirestore).setZone(DateTime.local().zoneName);
                            timeLabel = startTimeLuxon.toFormat('h:mm a'); // e.g., "3:30 PM"
                        } else {
                            timeLabel = "TBD";
                        }

                        const row1 = document.createElement("tr");
                        row1.className = "game-row";
                        row1.innerHTML = `
                            <td>${timeLabel}</td>
                            <td class="team-cell">${away}</td>
                            <td>${typeof awayScore !== "undefined" ? awayScore : ""}</td>
                            <td></td>
                        `;

                        const row2 = document.createElement("tr");
                        row2.className = "game-row";
                        row2.innerHTML = `
                            <td></td>
                            <td class="team-cell">${home}</td>
                            <td>${typeof homeScore !== "undefined" ? homeScore : ""}</td>
                            <td></td>
                        `;

                        table.appendChild(row1);
                        table.appendChild(row2);
                    });

                    leagueSection.appendChild(table);
                    container.appendChild(leagueSection);
                }

            } catch (err) {
                console.error("Error fetching games:", err);
                errorDiv.textContent = "Failed to load Firestore data: " + err.message;
            }
        }

        // Initial fetch when the page loads
        fetchGames();
    </script>
</body>
</html>
