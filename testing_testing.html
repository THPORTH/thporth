<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Firestore Live Games Viewer</title>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      background-color: #111;
      color: #e0e0e0;
      font-family: sans-serif;
      padding: 2rem;
    }
    .league-section {
      margin-bottom: 3rem;
    }
    .league-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #555;
      padding-bottom: 0.3rem;
    }
    .game-row {
      border-bottom: 1px solid #333;
      padding: 0.5rem 0;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Live & Upcoming Games</h1>
  <div id="games"></div>
  <div id="error" class="error"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3bw8d4q2oO2qpbgGiUG6Qnlf4aABK3Bc",
      authDomain: "flashlive-daily-scraper.firebaseapp.com",
      projectId: "flashlive-daily-scraper",
      storageBucket: "flashlive-daily-scraper.appspot.com",
      messagingSenderId: "124291936014",
      appId: "1:124291936014:web:acadcaa791d6046849315f",
      measurementId: "G-R146KS92QJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const collectionRef = db.collection("artifacts/flashlive-daily-scraper/public/data/sportsGames");

    async function fetchGamesNoFilter() {
      const container = document.getElementById("games");
      const errorDiv = document.getElementById("error");
      container.innerHTML = "";
      errorDiv.textContent = "";

      try {
        const snapshot = await collectionRef
          .orderBy("Start Time")
          .limit(100)
          .get();

        if (snapshot.empty) {
          container.innerHTML = "<p>No games found in Firestore collection.</p>";
          return;
        }

        const leagueGroups = {};
        snapshot.docs.forEach(doc => {
          const data = doc.data();
          const league = data.League || "Other";
          if (!leagueGroups[league]) {
            leagueGroups[league] = [];
          }
          leagueGroups[league].push(data);
        });

        for (const [leagueName, games] of Object.entries(leagueGroups)) {
          const leagueSection = document.createElement("div");
          leagueSection.className = "league-section";

          const title = document.createElement("div");
          title.className = "league-title";
          title.textContent = leagueName;
          leagueSection.appendChild(title);

          games.forEach(data => {
            const row = document.createElement("div");
            row.className = "game-row";

            const home = data["Home Team"] || "";
            const away = data["Away Team"] || "";
            const homeScore = data["Home Score"];
            const awayScore = data["Away Score"];
            const matchStatus = data["Match Status"] || "";
            const inningStatus = data["Status"] || "";
            const rawStart = data["Start Time"];

            const isLive =
              matchStatus.toUpperCase() === "LIVE" ||
              inningStatus.toUpperCase().includes("INNING");

            let displayText = "";

            if (isLive) {
              const liveStatus = inningStatus || matchStatus;
              const scoreLine = (homeScore !== undefined && awayScore !== undefined)
                ? `${home} ${homeScore} – ${awayScore} ${away}`
                : `${home} vs ${away}`;
              displayText = `${liveStatus} | ${scoreLine}`;
            } else if (rawStart) {
              let gameDate;
              if (typeof rawStart?.toDate === "function") {
                gameDate = rawStart.toDate();
              } else if (typeof rawStart === "number") {
                gameDate = new Date(rawStart * 1000); // Convert seconds → ms
              } else {
                gameDate = new Date(rawStart);
              }

              const localTime = gameDate.toLocaleTimeString(undefined, {
                hour: "numeric",
                minute: "2-digit",
                hour12: true
              });

              displayText = `${home} vs ${away} | ${localTime}`;
            } else {
              displayText = `${home} vs ${away}`;
            }

            row.innerHTML = `<span>${displayText}</span>`;
            leagueSection.appendChild(row);
          });

          container.appendChild(leagueSection);
        }

      } catch (err) {
        console.error("Error fetching games:", err);
        errorDiv.textContent = "Failed to load Firestore data: " + err.message;
      }
    }

    fetchGamesNoFilter();
  </script>
</body>
</html>
