<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Schedule</title>
    
    <!-- REQUIRED EXTERNAL LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #121212;
            color: #e5e7eb;
            padding: 20px;
        }
        .league-page-container {
            max-width: 550px;
            margin: 0 auto 40px auto;
        }
        .league-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #4a4a4a;
        }
        .game-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .game-row .team-cell {
            font-weight: 500;
        }
        .game-row td {
            padding: 8px 4px;
        }
        .game-separator {
            border-bottom: 1px solid #374151;
        }
        .game-time {
            width: 80px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .live-status {
            color: #ef4444;
            font-weight: bold;
        }
        .final-status {
            color: #9ca3af;
        }
        .winner {
            font-weight: bold;
            color: #ffffff;
        }
    </style>
</head>
<body>

    <!-- 1. FRONT-END HTML for MLB -->
    <div id="mlb-page" class="league-page-container">
        <h1 class="league-title">MLB Schedule</h1>
        <div id="mlb-games-output">
            <p>Loading MLB games...</p>
        </div>
    </div>

    <!-- 2. BACK-END SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- Firebase Configuration (Initialize once) ---
            const firebaseConfig = {
                apiKey: "AIzaSyD3bw8d4q2oO2qpbgGiUG6Qnlf4aABK3Bc",
                authDomain: "flashlive-daily-scraper.firebaseapp.com",
                projectId: "flashlive-daily-scraper",
                storageBucket: "flashlive-daily-scraper.appspot.com",
                messagingSenderId: "124291936014",
                appId: "1:124291936014:web:acadcaa791d6046849315f"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const gamesCollectionRef = db.collection("artifacts/flashlive-daily-scraper/public/data/sportsGames");

            // --- Helper Functions ---
            function getTeamDisplayName(originalTeamName) {
                const exactTeamMaps = { "Arizona Diamondbacks": "Diamondbacks", "Atlanta Braves": "Braves", "Baltimore Orioles": "Orioles", "Boston Red Sox": "Red Sox", "Chicago Cubs": "Cubs", "Chicago White Sox": "White Sox", "Cincinnati Reds": "Reds", "Cleveland Guardians": "Guardians", "Colorado Rockies": "Rockies", "Detroit Tigers": "Tigers", "Houston Astros": "Astros", "Kansas City Royals": "Royals", "Los Angeles Angels": "Angels", "Los Angeles Dodgers": "Dodgers", "Miami Marlins": "Marlins", "Milwaukee Brewers": "Brewers", "Minnesota Twins": "Twins", "New York Mets": "Mets", "New York Yankees": "Yankees", "Athletics": "Athletics", "Philadelphia Phillies": "Phillies", "Pittsburgh Pirates": "Pirates", "San Diego Padres": "Padres", "San Francisco Giants": "Giants", "Seattle Mariners": "Mariners", "St. Louis Cardinals": "Cardinals", "Tampa Bay Rays": "Rays", "Texas Rangers": "Rangers", "Toronto Blue Jays": "Blue Jays", "Washington Nationals": "Nationals" };
                return exactTeamMaps[originalTeamName] || originalTeamName;
            }

            function getOrdinal(n) {
                const num = parseInt(n, 10);
                if (isNaN(num)) return n;
                const s = ["th", "st", "nd", "rd"];
                const v = num % 100;
                return num + (s[(v - 20) % 10] || s[v] || s[0]);
            }

            /**
            * DYNAMIC FUNCTION TO DISPLAY GAMES FOR ANY LEAGUE
            * @param {string} leagueId - The exact league ID from Firestore (e.g., 'USA: MLB').
            * @param {string} containerId - The ID of the HTML element to render the games into.
            * @param {string} leagueName - The display name of the league (e.g., 'MLB').
            */
            function displayLeagueGames(leagueId, containerId, leagueName) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container with ID "${containerId}" not found.`);
                    return;
                }

                const { DateTime } = luxon;
                const todayStr = DateTime.now().setZone('America/New_York').toISODate();
                
                gamesCollectionRef
                    .where('gameDate', '==', todayStr)
                    .where('League', '==', leagueId)
                    .onSnapshot(snapshot => {
                        if (snapshot.empty) {
                            container.innerHTML = `<p>No ${leagueName} games found for today.</p>`;
                            return;
                        }
                        
                        const sortedDocs = snapshot.docs.sort((a, b) => a.data()["Start Time"].toMillis() - b.data()["Start Time"].toMillis());

                        container.innerHTML = "";
                        const table = document.createElement("table");
                        table.className = "game-table";
                        let lastDisplayedTimeLabel = null;

                        sortedDocs.forEach(doc => {
                            const data = doc.data();
                            const home = getTeamDisplayName(data["Home Team"] || "");
                            const away = getTeamDisplayName(data["Away Team"] || "");
                            const homeScore = data["Home Score"];
                            const awayScore = data["Away Score"];
                            const matchStatus = (data["Match Status"] || "").toUpperCase();
                            const inningStatus = (data["Status"] || "");
                            const rawStart = data["Start Time"];
                            const isLive = matchStatus.includes("PROGRESS") || matchStatus.includes("LIVE");
                            const isFinal = matchStatus === "FINISHED";
                            let currentTimeLabel = "";
                            
                            if (isLive) {
                                let parsedStatus = 'Live';
                                const inningMatch = inningStatus.match(/(Top|Bottom|Mid|End).*?(\d+)/i);
                                if (inningMatch) {
                                    parsedStatus = `${inningMatch[1].slice(0, 3)} ${getOrdinal(inningMatch[2])}`;
                                } else if (inningStatus) {
                                    parsedStatus = inningStatus;
                                }
                                currentTimeLabel = `<span class="live-status">${parsedStatus}</span>`;
                            } else if (isFinal) {
                                currentTimeLabel = `<span class="final-status">Final</span>`;
                            } else if (rawStart && rawStart.toDate) {
                                currentTimeLabel = luxon.DateTime.fromJSDate(rawStart.toDate()).toFormat('h:mm a');
                            } else {
                                currentTimeLabel = "TBD";
                            }

                            let displayTimeLabel = currentTimeLabel;
                            if (!isLive && !isFinal && currentTimeLabel !== "TBD") {
                                if (currentTimeLabel === lastDisplayedTimeLabel) {
                                    displayTimeLabel = "";
                                } else {
                                    lastDisplayedTimeLabel = currentTimeLabel;
                                }
                            }
                            
                            const isAwayWinner = isFinal && parseInt(awayScore) > parseInt(homeScore);
                            const isHomeWinner = isFinal && parseInt(homeScore) > parseInt(awayScore);

                            const row1 = table.insertRow();
                            row1.className = "game-row";
                            row1.innerHTML = `<td class="game-time" rowspan="2">${displayTimeLabel}</td><td class="team-cell ${isAwayWinner ? 'winner' : ''}">${away}</td><td style="text-align: right;" class="${isAwayWinner ? 'winner' : ''}">${awayScore ?? ''}</td>`;
                            
                            const row2 = table.insertRow();
                            row2.className = "game-row game-separator";
                            row2.innerHTML = `<td class="team-cell ${isHomeWinner ? 'winner' : ''}">${home}</td><td style="text-align: right;" class="${isHomeWinner ? 'winner' : ''}">${homeScore ?? ''}</td>`;
                        });
                        
                        container.appendChild(table);

                    }, err => {
                        console.error(`Error fetching ${leagueName} games:`, err);
                        container.innerHTML = `<p style='color: #ef4444;'>Error loading game data.</p>`;
                    });
            }

            // --- INITIAL CALL ---
            // This now only calls the function for MLB.
            displayLeagueGames('USA: MLB', 'mlb-games-output', 'MLB');

        });
    </script>

</body>
</html>
